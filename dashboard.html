<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Store Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      color: #ff5a1f;
    }
    #user-info {
      margin-bottom: 16px;
      font-size: 14px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 13px;
    }
    th {
      background: #ff5a1f;
      color: #fff;
      text-align: left;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
    .message {
      margin-top: 12px;
      font-size: 13px;
    }
    .message.error { color: #d32f2f; }
  </style>
</head>
<body>
  <h1>Store Dashboard</h1>
  <div id="user-info"></div>
  <div id="message" class="message"></div>
  <div id="table-container"></div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbzaSG7ZJs5YpCr_sNFg6vD6SUJRBDwfa3YU2dKeMHlADVBn7gZ1cT889omGHo3ocKkTLg/exec';

  // Ensure user is logged in
  const storedUser = sessionStorage.getItem('username');
  const storedRole = sessionStorage.getItem('role');

  const userInfoDiv = document.getElementById('user-info');
  const msgDiv = document.getElementById('message');
  const tableContainer = document.getElementById('table-container');

  if (!storedUser) {
    // Not logged in, redirect to login
    window.location.href = 'login.html';
  } else {
    userInfoDiv.textContent = `Logged in as: ${storedUser} (${storedRole || 'no role'})`;
    loadDataForUser(storedUser);
  }

  async function loadDataForUser(username) {
    msgDiv.textContent = 'Loading data...';
    msgDiv.className = 'message';

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'getStoreDataForUser',
          username: username
        })
      });

      const data = await res.json();

      if (!data.success) {
        msgDiv.textContent = data.message || 'Error loading data';
        msgDiv.className = 'message error';
        return;
      }

      const rows = data.data || [];
      if (rows.length === 0) {
        msgDiv.textContent = 'No data available for your user.';
        tableContainer.innerHTML = '';
        return;
      }

      msgDiv.textContent = '';
      renderTable(rows);
    } catch (err) {
      console.error(err);
      msgDiv.textContent = 'Unexpected error fetching data.';
      msgDiv.className = 'message error';
    }
  }

  function renderTable(rows) {
    let html = '<table><thead><tr>';
    html += '<th>Order Date</th>';
    html += '<th>Store ID</th>';
    html += '<th>Store Name Area</th>';
    html += '<th>Merchant Name</th>';
    html += '<th>Orders</th>';
    html += '<th>Del Orders</th>';
    html += '<th>GMV</th>';
    html += '<th>Total Units</th>';
    html += '<th>Del Units</th>';
    html += '<th>GC Units</th>';
    html += '<th>NC Units</th>';
    html += '<th>Acceptance Duration</th>';
    html += '<th>RTS Time</th>';
    html += '<th>RTS Adherence Orders</th>';
    html += '<th>RTS Orders</th>';
    html += '<th>Country</th>';
    html += '<th>Store Rating</th>';
    html += '</tr></thead><tbody>';

    rows.forEach(r => {
      html += '<tr>';
      html += `<td>${r.order_date}</td>`;
      html += `<td>${r.store_id}</td>`;
      html += `<td>${r.store_name_area}</td>`;
      html += `<td>${r.merchant_name}</td>`;
      html += `<td>${r.orders}</td>`;
      html += `<td>${r.del_orders}</td>`;
      html += `<td>${r.gmv}</td>`;
      html += `<td>${r.total_units}</td>`;
      html += `<td>${r.del_units}</td>`;
      html += `<td>${r.gc_units}</td>`;
      html += `<td>${r.nc_units}</td>`;
      html += `<td>${r.acceptance_duration}</td>`;
      html += `<td>${r.rts_time}</td>`;
      html += `<td>${r.rtsadherence_orders}</td>`;
      html += `<td>${r.rts_orders}</td>`;
      html += `<td>${r.country_code}</td>`;
      html += `<td>${r.store_rating}</td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';
    tableContainer.innerHTML = html;
  }
</script>
</body>
</html>
